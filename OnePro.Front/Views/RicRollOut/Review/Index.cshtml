@using Core.Contracts.RicRollOut.Responses
@using OnePro.Front.Helpers
@model List<RicRollOutListItemResponse>

@{
    ViewData["Title"] = "RIC RollOut Review";
    Layout = "_LayoutDashboard";

    var total = Model?.Count ?? 0;
    var userRole = (ViewBag.UserRole as string) ?? "";
    var isBRPic = string.Equals(userRole, "BR_Pic", StringComparison.OrdinalIgnoreCase);
    var isBRGroup = userRole.StartsWith("BR_", StringComparison.OrdinalIgnoreCase);
}

<!-- âœ… FIX: make content wider so table can scroll horizontally properly -->
<div class="w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">

        <!-- HEADER -->
        <div class="mt-8">
            <div class="bg-white rounded-2xl border border-gray-200/80 p-6">
                <div class="flex flex-row flex-wrap items-center justify-between gap-4">
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900 tracking-tight">Review RIC RollOut</h1>
                        <p class="text-sm text-gray-500 mt-1">
                            Daftar RollOut untuk direview sesuai role kamu.
                        </p>
                    </div>

                    <div class="inline-flex items-center gap-2 text-xs text-gray-500">
                        <span class="px-3 py-2 rounded-xl border border-gray-200 bg-gray-50">
                            Role: <span class="font-semibold text-gray-700">@userRole</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOLBAR -->
        <div class="mt-6 bg-white rounded-2xl border border-gray-200/80 p-5">
            <div class="flex flex-row flex-wrap items-end gap-4">

                <div class="flex-1 min-w-[260px]">
                    <label class="text-xs text-gray-500">Search</label>
                    <div class="relative mt-1">
                        <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="rolloutSearch"
                               type="text"
                               placeholder="Cari entitas, judul aplikasi, user, atau ID..."
                               class="@InputBase("pl-10")" />
                    </div>
                </div>

                <div class="w-full min-w-[220px] md:w-56">
                    <label class="text-xs font-medium text-gray-600">Status</label>
                    <div class="relative mt-1">
                        <i class="ri-filter-3-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>

                        <select id="statusFilter"
                                class="w-full appearance-none pl-10 pr-9 py-2.5 rounded-xl border border-gray-200 bg-white text-sm
                                       focus:outline-none focus:ring-2 focus:ring-gray-900/10 hover:border-gray-300 transition">
                            <option value="">All Status</option>
                            <option value="@S.SubmittedToBR">Submitted_To_BR</option>
                            <option value="@S.ReviewBR">Review_BR</option>
                            <option value="@S.RejectedByBR">Rejected_By_BR</option>
                            <option value="@S.ApprovalManagerUser">Approval_Manager_User</option>
                            <option value="@S.ApprovalVpUser">Approval_VP_User</option>
                            <option value="@S.ApprovalManagerBr">Approval_Manager_BR</option>
                            <option value="@S.Done">Done</option>
                        </select>

                        <i class="ri-arrow-down-s-line absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <button id="clearFilter"
                        type="button"
                        class="@BtnGhost()">
                    <i class="ri-refresh-line"></i>
                    Reset
                </button>
            </div>
        </div>

        <!-- TABLE -->
        <div class="mt-6 bg-white rounded-2xl border border-gray-200/80 overflow-hidden">
            <!-- âœ… Keep this, it enables horizontal scrolling -->
            <div class="overflow-x-auto">
                <!-- âœ… FIX: min-w-max makes table expand beyond container so scroll appears -->
                <table class="min-w-max w-full text-sm">
                    <thead class="bg-gray-50/60 text-gray-500 uppercase text-xs whitespace-nowrap">
                        <tr>
                            <th class="px-6 py-4 text-left">ID</th>
                            <th class="px-6 py-4 text-left">Entitas</th>
                            <th class="px-6 py-4 text-left">Judul Aplikasi</th>
                            <th class="px-6 py-4 text-left">User PIC</th>
                            <th class="px-6 py-4 text-left">Status</th>
                            <th class="px-6 py-4 text-left">Last Update</th>
                            <th class="px-6 py-4 text-center">Action</th>
                        </tr>
                    </thead>

                    <tbody id="rolloutTableBody" class="divide-y divide-gray-100">
                        @if (Model?.Any() == true)
                        {
                            foreach (var item in Model)
                            {
                                var status = item.Status ?? "";
                                var statusLabel = DisplayStatus(status);

                                <tr class="hover:bg-gray-50 transition"
                                    data-status="@status"
                                    data-search="@BuildSearch(item)">

                                    <td class="px-6 py-4 font-mono text-xs text-gray-500 whitespace-nowrap">
                                        <div class="truncate max-w-[10rem]" title="@item.Id">@item.Id</div>
                                    </td>

                                    <td class="px-6 py-4">
                                        <div class="font-medium text-gray-900 leading-snug">
                                            @Trunc(item.Entitas, 30)
                                        </div>
                                    </td>

                                    <td class="px-6 py-4">
                                        <div class="font-medium text-gray-900 leading-snug">
                                            @Trunc(item.JudulAplikasi, 60)
                                        </div>
                                    </td>

                                    <td class="px-6 py-4 text-gray-700 whitespace-nowrap">@item.UserName</td>

                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="@($"{GetStatusBadgeClass(status)} inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium")">
                                            @statusLabel
                                        </span>
                                    </td>

                                    <td class="px-6 py-4 text-xs text-gray-500 whitespace-nowrap">
                                        @item.UpdatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </td>

                                    <td class="px-6 py-4">
                                        <div class="flex items-center justify-center gap-2 whitespace-nowrap">

                                            <a asp-action="ReviewEdit"
                                               asp-route-id="@item.Id"
                                               class="@IconBtn()"
                                               title="Open Review">
                                                <i class="ri-eye-line text-gray-700"></i>
                                            </a>

                                            @if (isBRPic && IsReviewStage(status))
                                            {
                                                <a asp-action="ReviewEdit"
                                                   asp-route-id="@item.Id"
                                                   class="inline-flex items-center gap-2 rounded-2xl border border-gray-200 px-4 py-2 hover:bg-indigo-50 transition"
                                                   title="Review RollOut">
                                                    <i class="ri-file-search-line text-indigo-700 text-lg"></i>
                                                    <span class="text-sm font-medium text-indigo-700">Review</span>
                                                </a>
                                            }
                                            else if (isBRGroup)
                                            {
                                                <a asp-action="ReviewEdit"
                                                   asp-route-id="@item.Id"
                                                   class="inline-flex items-center gap-2 rounded-2xl border border-gray-200 px-4 py-2 hover:bg-gray-100 transition"
                                                   title="View RollOut">
                                                    <i class="ri-eye-line text-gray-700 text-lg"></i>
                                                    <span class="text-sm font-medium text-gray-700">View</span>
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center justify-center gap-2">
                                        <div class="w-14 h-14 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center">
                                            <i class="ri-inbox-line text-3xl text-gray-300"></i>
                                        </div>
                                        <p class="text-gray-700 font-semibold">Belum ada RollOut untuk direview.</p>
                                        <p class="text-gray-500 text-sm">Kalau udah ada, bakal muncul di sini ðŸ˜‰</p>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 text-xs text-gray-500 flex items-center justify-between">
                <span>Gunakan search & filter untuk mempercepat pencarian.</span>
                <span class="font-medium">
                    Showing <span id="shownCount">@total</span> of @total
                </span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function () {
  const searchInput = document.getElementById('rolloutSearch');
  const statusFilter = document.getElementById('statusFilter');
  const clearBtn = document.getElementById('clearFilter');
  const tbody = document.getElementById('rolloutTableBody');
  const shownCount = document.getElementById('shownCount');

  if (!searchInput || !statusFilter || !clearBtn || !tbody) return;

  const rows = Array.from(tbody.querySelectorAll('tr[data-search]'));

  function applyFilter() {
    const q = (searchInput.value || '').trim().toLowerCase();
    const s = (statusFilter.value || '').trim();

    let visible = 0;

    rows.forEach(r => {
      const hay = (r.getAttribute('data-search') || '');
      const st = (r.getAttribute('data-status') || '');
      const show = (!q || hay.includes(q)) && (!s || st === s);

      r.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (shownCount) shownCount.textContent = visible;
  }

  searchInput.addEventListener('input', applyFilter);
  statusFilter.addEventListener('change', applyFilter);
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    statusFilter.value = '';
    applyFilter();
  });

  applyFilter();
})();
</script>
}

@functions {
    private static class S
    {
        public const string Draft = "Draft";
        public const string SubmittedToBR = "Submitted_To_BR";
        public const string ReviewBR = "Review_BR";
        public const string RejectedByBR = "Rejected_By_BR";
        public const string ApprovalManagerUser = "Approval_Manager_User";
        public const string ApprovalVpUser = "Approval_VP_User";
        public const string ApprovalManagerBr = "Approval_Manager_BR";
        public const string Done = "Done";
    }

    private bool IsReviewStage(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return false;
        return status == S.SubmittedToBR || status == S.ReviewBR;
    }

    private string DisplayStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "-";
        return status;
    }

    private string Trunc(string? text, int max)
    {
        if (string.IsNullOrWhiteSpace(text)) return "-";
        return text.Length > max ? text.Substring(0, max) + "..." : text;
    }

    private string BuildSearch(RicRollOutListItemResponse item)
    {
        var parts = $"{item.Id} {item.Entitas} {item.JudulAplikasi} {item.UserName} {item.Status}";
        return parts.ToLowerInvariant();
    }

    private string InputBase(string extra = "")
        => $"w-full {extra} pr-3 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-900/10 text-sm";

    private string BtnGhost()
        => "inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border border-gray-200 text-sm text-gray-700 hover:bg-gray-50 transition";

    private string IconBtn(string extraHover = "hover:bg-gray-100")
        => $"w-9 h-9 inline-flex items-center justify-center rounded-lg border border-gray-200 {extraHover} transition";

    private string GetStatusBadgeClass(string status)
        => StatusBadgeHelper.GetStatusBadgeClass(status);
}
