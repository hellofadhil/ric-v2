@model OnePro.Front.ViewModels.Ric.RicCreateViewModel
@using Microsoft.AspNetCore.Html

@{
    ViewBag.Title = "Edit RIC New Development & Enhancement";
    Layout = "_LayoutDashboard";
}

<div class="min-h-screen bg-slate-50">
    <div class="max-w-6xl mx-auto px-2 sm:px-6 py-4">

        <form asp-controller="RicUser"
              asp-action="Edit"
              asp-route-id="@Model.Id"
              method="post"
              enctype="multipart/form-data">

            @Html.AntiForgeryToken()

            <!-- Judul Permintaan -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Judul Permintaan
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Jelaskan secara singkat dan jelas apa yang mau lo ajukan.
                    </p>
                </div>
                <div class="px-6 py-4">
                    <input asp-for="JudulPermintaan"
                           class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500" />
                    <span asp-validation-for="JudulPermintaan" class="text-xs text-red-500"></span>
                </div>
            </div>

            <!-- Hashtag -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Hashtag
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Tambahkan hashtag buat ngelompokkin RIC lo (misal: process, digital, cost-saving).
                    </p>
                </div>
                <div class="px-6 py-4 space-y-3">
                    <div id="hashtag-badges" class="flex flex-wrap gap-2">
                        @if (Model.Hashtags != null && Model.Hashtags.Any())
                        {
                            var idx = 0;
                            foreach (var tag in Model.Hashtags)
                            {
                                <span class="tag-badge inline-flex items-center gap-1 rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-medium text-indigo-700 border border-indigo-100">
                                    <span>#@tag</span>
                                    <button type="button"
                                            class="tag-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-indigo-100 text-[10px] text-indigo-600"
                                            data-tag="@tag">×</button>
                                    <input type="hidden" name="Hashtags[@idx]" value="@tag" />
                                </span>
                                idx++;
                            }
                        }
                        else
                        {
                            <span class="text-xs text-slate-400 empty-hashtag-placeholder">
                                Belum ada hashtag. Tambahin buat ngelompokkin RIC lo.
                            </span>
                        }
                    </div>

                    <input id="hashtag-input"
                           type="text"
                           class="block w-full rounded-lg border border-dashed border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"
                           placeholder="Ketik hashtag lalu Enter (tanpa # juga boleh)" />
                </div>
            </div>

            <!-- As-is Process & RASCI -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        As-is Process & RASCI
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Upload dokumen proses saat ini dan RASCI yang berlaku. Kalau gak mau ganti file, kosongin aja.
                    </p>
                </div>
                <div class="px-6 py-4 space-y-3">

                    @* Tampilkan file lama kalau ada *@
                    @if (Model.ExistingAsIsFileUrls != null && Model.ExistingAsIsFileUrls.Any())
                    {
                        <div class="mb-2 text-xs text-slate-600">
                            <span class="font-medium">File saat ini:</span>
                            <div class="mt-2">
                                <a href="@($"/Ric/User/Files/{Model.Id}/asis")"
                                   class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50 transition">
                                    <i class="ri-download-2-line"></i>
                                    Download all files (@Model.ExistingAsIsFileUrls.Count)
                                </a>
                            </div>
                            <p class="mt-1 text-[11px] text-slate-500">
                                Kosongkan input file di bawah kalau tidak ingin mengganti.
                            </p>
                        </div>
                    }

                    <label class="flex flex-col items-start justify-between gap-2 rounded-lg border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-xs text-slate-600 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/50 transition">
    <div class="flex flex-col gap-1">
        <span class="font-medium text-slate-700">Upload file baru (opsional, bisa lebih dari satu)</span>
        <span class="file-name text-[11px] text-slate-500">Belum ada file dipilih</span>
    </div>
    <input asp-for="AsIsRasciFiles" type="file" class="hidden" multiple />
</label>

<span asp-validation-for="AsIsRasciFiles" class="text-xs text-red-500"></span>

                </div>
            </div>

            <!-- Permasalahan -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Permasalahan
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Jelaskan masalah utama yang terjadi di proses saat ini.
                    </p>
                </div>
                <div class="px-6 py-4">
                    <textarea asp-for="Permasalahan"
                              rows="4"
                              class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    <span asp-validation-for="Permasalahan" class="text-xs text-red-500"></span>
                </div>
            </div>

            <!-- Dampak Masalah -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Dampak Masalah
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Ceritain impact konkret ke bisnis, waktu, cost, atau kualitas.
                    </p>
                </div>
                <div class="px-6 py-4">
                    <textarea asp-for="DampakMasalah"
                              rows="3"
                              class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    <span asp-validation-for="DampakMasalah" class="text-xs text-red-500"></span>
                </div>
            </div>

            <!-- Faktor Penyebab -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Faktor Penyebab Masalah
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Jelaskan akar masalahnya, bukan cuma gejala di permukaan.
                    </p>
                </div>
                <div class="px-6 py-4">
                    <textarea asp-for="FaktorPenyebab"
                              rows="3"
                              class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    <span asp-validation-for="FaktorPenyebab" class="text-xs text-red-500"></span>
                </div>
            </div>

            <!-- Solusi Saat Ini -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Solusi Saat Ini (kalau ada)
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Kalau sudah ada workaround / solusi sementara, tulis di sini.
                    </p>
                </div>
                <div class="px-6 py-4">
                    <textarea asp-for="SolusiSaatIni"
                              rows="3"
                              class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    <span asp-validation-for="SolusiSaatIni" class="text-xs text-red-500"></span>
                </div>
            </div>

            <!-- Alternatif Solusi -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Alternatif Solusi
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Tambahkan beberapa opsi solusi. Satu baris satu solusi, lalu tekan Enter.
                    </p>
                </div>
                <div class="px-6 py-4 space-y-3">
                    <div id="alternatif-badges" class="flex flex-wrap gap-2">
                        @if (Model.Alternatifs != null && Model.Alternatifs.Any())
                        {
                            var idxAlt = 0;
                            foreach (var alt in Model.Alternatifs)
                            {
                                <span class="alt-badge inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700 border border-emerald-100">
                                    <span>@alt</span>
                                    <button type="button"
                                            class="alt-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-[10px] text-emerald-600"
                                            data-alt="@alt">×</button>
                                    <input type="hidden" name="Alternatifs[@idxAlt]" value="@alt" />
                                </span>
                                idxAlt++;
                            }
                        }
                        else
                        {
                            <span class="text-xs text-slate-400 empty-alt-placeholder">
                                Belum ada alternatif. Tambah minimal satu opsi solusi.
                            </span>
                        }
                    </div>

                    <textarea id="alternatif-input"
                              rows="2"
                              class="block w-full rounded-lg border border-dashed border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:ring-emerald-500"
                              placeholder="Ketik alternatif solusi, lalu Enter. Bisa beberapa baris."></textarea>
                </div>
            </div>

            <!-- To-Be Process / Business RASCI -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        To-Be Process / Business RASCI / KKI
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Upload desain proses target atau dokumen pendukung lainnya.
                    </p>
                </div>
                <div class="px-6 py-4 space-y-3">
                    @if (Model.ExistingToBeFileUrls != null && Model.ExistingToBeFileUrls.Any())
                    {
                        <div class="mb-2 text-xs text-slate-600">
                            <span class="font-medium">File saat ini:</span>
                            <div class="mt-2">
                                <a href="@($"/Ric/User/Files/{Model.Id}/tobe")"
                                   class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50 transition">
                                    <i class="ri-download-2-line"></i>
                                    Download all files (@Model.ExistingToBeFileUrls.Count)
                                </a>
                            </div>
                            <p class="mt-1 text-[11px] text-slate-500">
                                Kosongkan input file di bawah kalau tidak ingin mengganti.
                            </p>
                        </div>
                    }

                    <label class="flex flex-col items-start justify-between gap-2 rounded-lg border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-xs text-slate-600 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/50 transition">
    <div class="flex flex-col gap-1">
        <span class="font-medium text-slate-700">Upload file baru (opsional, bisa lebih dari satu)</span>
        <span class="file-name text-[11px] text-slate-500">Belum ada file dipilih</span>
    </div>
    <input asp-for="ToBeProcessFiles" type="file" class="hidden" multiple />
</label>

                </div>
            </div>

            <!-- Expected Completion Target -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Expected Completion Target
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Upload timeline / target penyelesaian kalau ada.
                    </p>
                </div>
                <div class="px-6 py-4 space-y-3">
                    @if (Model.ExistingExpectedCompletionFileUrls != null && Model.ExistingExpectedCompletionFileUrls.Any())
                    {
                        <div class="mb-2 text-xs text-slate-600">
                            <span class="font-medium">File saat ini:</span>
                            <div class="mt-2">
                                <a href="@($"/Ric/User/Files/{Model.Id}/expected")"
                                   class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50 transition">
                                    <i class="ri-download-2-line"></i>
                                    Download all files (@Model.ExistingExpectedCompletionFileUrls.Count)
                                </a>
                            </div>
                            <p class="mt-1 text-[11px] text-slate-500">
                                Kosongkan input file di bawah kalau tidak ingin mengganti.
                            </p>
                        </div>
                    }

                    <label class="flex flex-col items-start justify-between gap-2 rounded-lg border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-xs text-slate-600 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/50 transition">
    <div class="flex flex-col gap-1">
        <span class="font-medium text-slate-700">Upload file baru (opsional, bisa lebih dari satu)</span>
        <span class="file-name text-[11px] text-slate-500">Belum ada file dipilih</span>
    </div>
    <input asp-for="ExpectedCompletionFiles" type="file" class="hidden" multiple />
</label>

                </div>
            </div>

            <!-- Potensi Value Creation -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
                <div class="px-6 py-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">
                        Potensi Value Creation
                    </h2>
                    <p class="mt-1 text-xs text-slate-500">
                        Jelaskan potensi manfaat (efisiensi, cost saving, risk reduction, dll).
                    </p>
                </div>
                <div class="px-6 py-4">
                    <textarea asp-for="PotentialValue"
                              rows="3"
                              class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    <span asp-validation-for="PotentialValue" class="text-xs text-red-500"></span>
                </div>
            </div>

            <!-- Hasil Setelah Perbaikan (opsional, bisa diisi belakangan) -->
            <div class="mb-4 rounded-xl bg-white shadow-sm border border-slate-100">
    <div class="px-6 py-4 border-b border-slate-100">
        <h2 class="text-sm font-semibold text-slate-800">
            Hasil Setelah Perbaikan
        </h2>
        <p class="mt-1 text-xs text-slate-500">
            Bisa diupdate setelah implementasi. Untuk sekarang boleh dikosongin kalau belum ada hasil.
        </p>
    </div>
    <div class="px-6 py-4">
        <textarea asp-for="HasilSetelahPerbaikan"
                  rows="3"
                  class="block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
        <span asp-validation-for="HasilSetelahPerbaikan" class="text-xs text-red-500"></span>
    </div>
</div>


            <!-- Footer tombol -->
            <div class="flex flex-col gap-4 border-t border-slate-100 bg-white px-8 py-4 sm:flex-row sm:items-center sm:justify-between">
                <a asp-action="UserIndex"
                   class="inline-flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-slate-700">
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-slate-300 text-[11px]">
                        ←
                    </span>
                    Kembali
                </a>

                <div class="flex items-center gap-3">
                    <button type="submit" name="action" value="save"
                            class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-5 py-2.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-100 transition-colors">
                        Simpan Draft
                    </button>
                    <button type="submit" name="action" value="submit"
                            class="inline-flex items-center justify-center rounded-lg border border-indigo-600 bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-1 focus:ring-offset-slate-50 transition-all">
                        Ajukan RIC
                    </button>
                </div>
            </div>
        </form>

    </div>
</div>

@section Scripts {
    <script>
        // ===== HASHTAG =====
        (function () {
            const badgesContainer = document.getElementById('hashtag-badges');
            const input = document.getElementById('hashtag-input');

            function createTagBadge(tag) {
                tag = tag.trim();
                if (!tag) return;

                const exists = badgesContainer.querySelector('input[type="hidden"][value="' + tag + '"]');
                if (exists) return;

                const index = badgesContainer.querySelectorAll('input[type="hidden"]').length;

                const placeholder = badgesContainer.querySelector('.empty-hashtag-placeholder');
                if (placeholder) placeholder.remove();

                const span = document.createElement('span');
                span.className = 'tag-badge inline-flex items-center gap-1 rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-medium text-indigo-700 border border-indigo-100';

                span.innerHTML =
                    '<span>#' + tag + '</span>' +
                    '<button type="button" class="tag-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-indigo-100 text-[10px] text-indigo-600" data-tag="' + tag + '">×</button>' +
                    '<input type="hidden" name="Hashtags[' + index + ']" value="' + tag + '" />';

                badgesContainer.appendChild(span);
            }

            if (input) {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const value = input.value.replace(/^#+/, '');
                        if (value.trim()) {
                            createTagBadge(value);
                            input.value = '';
                        }
                    }
                });
            }

            if (badgesContainer) {
                badgesContainer.addEventListener('click', function (e) {
                    if (e.target.classList.contains('tag-remove')) {
                        const badge = e.target.closest('.tag-badge');
                        if (badge) badge.remove();

                        const hiddenInputs = badgesContainer.querySelectorAll('input[type="hidden"]');
                        hiddenInputs.forEach((inp, idx) => {
                            inp.name = 'Hashtags[' + idx + ']';
                        });

                        if (hiddenInputs.length === 0) {
                            const span = document.createElement('span');
                            span.className = 'text-xs text-slate-400 empty-hashtag-placeholder';
                            span.textContent = 'Belum ada hashtag. Tambahin buat ngelompokkin RIC lo.';
                            badgesContainer.appendChild(span);
                        }
                    }
                });
            }
        })();

        // ===== ALTERNATIF SOLUSI =====
        (function () {
            const badgesContainer = document.getElementById('alternatif-badges');
            const input = document.getElementById('alternatif-input');

            function createAltBadge(text) {
                text = text.trim();
                if (!text) return;

                const index = badgesContainer.querySelectorAll('input[type="hidden"]').length;

                const placeholder = badgesContainer.querySelector('.empty-alt-placeholder');
                if (placeholder) placeholder.remove();

                const span = document.createElement('span');
                span.className = 'alt-badge inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700 border border-emerald-100';

                span.innerHTML =
                    '<span>' + text + '</span>' +
                    '<button type="button" class="alt-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-[10px] text-emerald-600" data-alt="' + text + '">×</button>' +
                    '<input type="hidden" name="Alternatifs[' + index + ']" value="' + text + '" />';

                badgesContainer.appendChild(span);
            }

            if (input) {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const lines = input.value.split('\n');
                        lines.forEach(line => createAltBadge(line));
                        input.value = '';
                    }
                });
            }

            if (badgesContainer) {
                badgesContainer.addEventListener('click', function (e) {
                    if (e.target.classList.contains('alt-remove')) {
                        const badge = e.target.closest('span.alt-badge');
                        if (badge) badge.remove();

                        const hiddenInputs = badgesContainer.querySelectorAll('input[type="hidden"]');
                        hiddenInputs.forEach((inp, idx) => {
                            inp.name = 'Alternatifs[' + idx + ']';
                        });

                        if (hiddenInputs.length === 0) {
                            const span = document.createElement('span');
                            span.className = 'text-xs text-slate-400 empty-alt-placeholder';
                            span.textContent = 'Belum ada alternatif. Tambah minimal satu opsi solusi.';
                            badgesContainer.appendChild(span);
                        }
                    }
                });
            }
        })();

        // Update nama file kalau user pilih file baru
        document.addEventListener("change", function (e) {
    if (!(e.target instanceof HTMLInputElement)) return;
    if (e.target.type !== "file") return;

    const files = e.target.files;
    if (!files || files.length === 0) return;

    const label = e.target.closest("label");
    if (!label) return;

    const nameEl = label.querySelector(".file-name");
    if (!nameEl) return;

    if (files.length === 1) {
        nameEl.textContent = files[0].name;
    } else {
        nameEl.textContent = files.length + " file dipilih";
    }
});

    </script>
}
