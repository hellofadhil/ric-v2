using System.Text.RegularExpressions;
using Core.Models.Enums;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using OnePro.Front.Helpers;
using OnePro.Front.Mappers;
using OnePro.Front.Middleware;
using OnePro.Front.Models;
using OnePro.Front.Services.Interfaces;

namespace OnePro.Front.Controllers
{
    [AuthRequired]
    public class RicController : Controller
    {
        private readonly IRicService _ricService;
        private readonly ILogger<RicController> _logger;
        private readonly IWebHostEnvironment _env;

        public RicController(
            IRicService ricService,
            ILogger<RicController> logger,
            IWebHostEnvironment env
        )
        {
            _ricService = ricService;
            _logger = logger;
            _env = env;
        }

        #region User Views

        [RoleRequired(0, 1, 2, 3)]
        [HttpGet("ric/user")]
        public async Task<IActionResult> UserIndex()
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            var rics = await _ricService.GetMyRicsAsync(token);
            return View("~/Views/Ric/User/Index.cshtml", rics);
        }

        [HttpGet("ric/br/review")]
        public async Task<IActionResult> ReviewIndex()
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            var userRole = HttpContext.Session.GetString("UserRole"); // "0","1","4",...
            _logger.LogInformation(
                "ReviewIndex accessed. UserRole from session: {UserRole}",
                userRole
            );

            ViewBag.UserRole = userRole;

            var rics = await _ricService.GetMyRicsAsync(token);
            return View("~/Views/Ric/Review/Index.cshtml", rics);
        }

        [RoleRequired(1, 4)]
        [HttpGet("ric/user/create")]
        public IActionResult Create()
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            return View("~/Views/Ric/User/Create.cshtml", new RicCreateViewModel());
        }

        [HttpPost("ric/user/create")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create(RicCreateViewModel model, string action)
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            if (!ModelState.IsValid)
                return View("~/Views/Ric/User/Create.cshtml", model);

            try
            {
                var dto = await RicMapper.MapToCreateRequestAsync(
                    model,
                    action,
                    files => FileStorageHelper.SaveRicFilesAsync(files, _env.WebRootPath, _logger)
                );

                await _ricService.CreateRicAsync(dto, token);

                TempData["SuccessMessage"] = "RIC berhasil dibuat!";
                return RedirectToAction(nameof(UserIndex));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error creating RIC");
                ModelState.AddModelError(string.Empty, "Terjadi kesalahan saat membuat RIC.");
                return View("~/Views/Ric/User/Create.cshtml", model);
            }
        }

        [HttpGet("ric/user/edit/{id:guid}")]
        public async Task<IActionResult> Edit(Guid id)
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            var ric = await _ricService.GetRicByIdAsync(id, token);
            if (ric == null)
                return NotFound();

            if ((StatusRic)ric.Status != StatusRic.Draft)
            {
                TempData["ErrorMessage"] = "RIC hanya bisa diedit kalau status masih Draft.";
                return RedirectToAction(nameof(UserIndex));
            }

            var vm = RicMapper.MapToEditViewModel(ric);
            ModelState.Clear();

            return View("~/Views/Ric/User/Edit.cshtml", vm);
        }

        [HttpGet("ric/user/update/{id:guid}")]
        public async Task<IActionResult> Update(Guid id)
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            var ric = await _ricService.GetRicByIdAsync(id, token);
            if (ric == null)
                return NotFound();

            if ((StatusRic)ric.Status != StatusRic.Return_BR_To_User)
            {
                TempData["ErrorMessage"] =
                    "RIC hanya bisa diupdate kalau status masih Return_BR_To_User.";
                return RedirectToAction(nameof(UserIndex));
            }

            var vm = RicMapper.MapToEditViewModel(ric);
            ModelState.Clear();

            return View("~/Views/Ric/User/Update.cshtml", vm);
        }

        [HttpPost("ric/user/update/{id:guid}")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Update(Guid id, RicCreateViewModel model, string action)
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            if (!ModelState.IsValid)
                return View("~/Views/Ric/User/Update.cshtml", model);

            var existing = await _ricService.GetRicByIdAsync(id, token);
            if (existing == null)
                return NotFound();

            if ((StatusRic)existing.Status != StatusRic.Return_BR_To_User)
            {
                TempData["ErrorMessage"] =
                    "RIC hanya bisa diupdate kalau status masih Return_BR_To_User.";
                return RedirectToAction(nameof(UserIndex));
            }

            try
            {
                // action di UI sekarang cuma "submit"
                var dto = await RicMapper.MapToResubmitRequestAsync(
                    model,
                    action,
                    existing,
                    files => FileStorageHelper.SaveRicFilesAsync(files, _env.WebRootPath, _logger)
                );

                await _ricService.ResubmitRicAsync(id, dto, token);

                TempData["SuccessMessage"] = "RIC berhasil di-resubmit!";
                return RedirectToAction(nameof(UserIndex));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error resubmitting RIC {Id}", id);
                ModelState.AddModelError(string.Empty, "Terjadi kesalahan saat resubmit RIC.");
                return View("~/Views/Ric/User/Update.cshtml", model);
            }
        }

        [HttpPost("ric/user/edit/{id:guid}")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(Guid id, RicCreateViewModel model, string action)
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            if (!ModelState.IsValid)
                return View("~/Views/Ric/User/Edit.cshtml", model);

            var existing = await _ricService.GetRicByIdAsync(id, token);
            if (existing == null)
                return NotFound();

            if ((StatusRic)existing.Status != StatusRic.Draft)
            {
                TempData["ErrorMessage"] = "RIC hanya bisa diedit kalau status masih Draft.";
                return RedirectToAction(nameof(UserIndex));
            }

            try
            {
                var dto = await RicMapper.MapToUpdateRequestAsync(
                    id,
                    model,
                    action,
                    existing,
                    files => FileStorageHelper.SaveRicFilesAsync(files, _env.WebRootPath, _logger)
                );

                await _ricService.UpdateRicAsync(id, dto, token);

                TempData["SuccessMessage"] = "RIC berhasil diperbarui!";
                return RedirectToAction(nameof(UserIndex));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating RIC {Id}", id);
                ModelState.AddModelError(string.Empty, "Terjadi kesalahan saat update RIC.");
                return View("~/Views/Ric/User/Edit.cshtml", model);
            }
        }

        #endregion

        #region Review Views (BR/SARM/ECS)

        // GET: buka form review & edit (id di query sekali saja)
        [RoleRequired(4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)]
        [HttpGet("Ric/Review")]
        public async Task<IActionResult> ReviewEdit(Guid id)
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            var ric = await _ricService.GetRicByIdAsync(id, token);
            if (ric == null)
                return NotFound();

            var vm = RicMapper.MapToEditViewModel(ric);
            vm.Id = ric.Id;

            return View("~/Views/Ric/Review/Form.cshtml", vm);
        }

        // [HttpPost("ric/review")]
        // [ValidateAntiForgeryToken]
        // public async Task<IActionResult> ReviewForm(
        //     RicCreateViewModel model,
        //     [FromForm(Name = "action")] string submitAction,
        //     string? note
        // )
        // {
        //     var token = GetAuthToken();
        //     if (string.IsNullOrEmpty(token))
        //         return RedirectToLogin();

        //     submitAction = (submitAction ?? "").Trim().ToLowerInvariant();

        //     _logger.LogInformation(
        //         "ReviewForm POST | RicId={Id} | submitAction='{Action}' | noteLen={Len} | FormKeys={Keys}",
        //         model.Id,
        //         submitAction,
        //         note?.Length ?? 0,
        //         string.Join(",", Request.Form.Keys)
        //     );

        //     if (!ModelState.IsValid)
        //     {
        //         var errors = string.Join(
        //             " | ",
        //             ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage)
        //         );

        //         _logger.LogWarning(
        //             "ReviewForm INVALID | RicId={Id} | Errors={Errors}",
        //             model.Id,
        //             errors
        //         );
        //         return View("~/Views/Ric/Review/Form.cshtml", model);
        //     }

        //     if (submitAction == "reject")
        //     {
        //         if (string.IsNullOrWhiteSpace(note))
        //         {
        //             ModelState.AddModelError("", "Catatan penolakan wajib diisi.");
        //             return View("~/Views/Ric/Review/Form.cshtml", model);
        //         }

        //         await _ricService.RejectAsync(model.Id, note, token);
        //         return RedirectToAction(nameof(ReviewIndex));
        //     }

        //     if (submitAction == "approve")
        //     {
        //         // ... build req ...
        //         // var ok = await _ricService.ForwardAsync(model.Id, req, token);
        //         // if (!ok)
        //         // {
        //         //     ModelState.AddModelError("", "Gagal forward RIC ke API.");
        //         //     return View("~/Views/Ric/Review/Form.cshtml", model);
        //         // }

        //         return RedirectToAction(nameof(ReviewIndex));
        //     }

        //     _logger.LogWarning(
        //         "ReviewForm INVALID ACTION | RicId={Id} | submitAction='{Action}'",
        //         model.Id,
        //         submitAction
        //     );
        //     ModelState.AddModelError("", $"Action tidak valid: '{submitAction}'");
        //     return View("~/Views/Ric/Review/Form.cshtml", model);
        // }

        [RoleRequired(4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)]
        [HttpPost("ric/review")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ReviewForm(
            RicCreateViewModel model,
            string action,
            string? note
        )
        {
            var token = GetAuthToken();
            if (string.IsNullOrEmpty(token))
                return RedirectToLogin();

            // if (!ModelState.IsValid)
            //     return View("~/Views/Ric/Review/Form.cshtml", model);

            if (!ModelState.IsValid)
            {
                var errors = string.Join(
                    " | ",
                    ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage)
                );

                _logger.LogWarning(
                    "ReviewForm INVALID | RicId={Id} | Errors={Errors}",
                    model.Id,
                    errors
                );

                return View("~/Views/Ric/Review/Form.cshtml", model);
            }

            // ===== Reject =====
            if (action == "reject")
            {
                if (string.IsNullOrWhiteSpace(note))
                {
                    ModelState.AddModelError("", "Catatan penolakan wajib diisi.");
                    return View("~/Views/Ric/Review/Form.cshtml", model);
                }

                await _ricService.RejectAsync(model.Id, note, token);
                return RedirectToAction(nameof(ReviewIndex));
            }

            // ===== Approve / Confirm -> Forward =====
            if (action == "approve")
            {
                // Kalo file gak diubah, keep existing URL
                // Kalo user upload file baru, upload dulu dan pake URL hasil upload
                // var asIsUrls = await ResolveFileUrlsAsync(
                //     newFiles: model.AsIsRasciFiles,
                //     existingUrls: model.ExistingAsIsFileUrls,
                //     token: token
                // );

                // var toBeUrls = await ResolveFileUrlsAsync(
                //     newFiles: model.ToBeProcessFiles,
                //     existingUrls: model.ExistingToBeFileUrls,
                //     token: token
                // );

                // var expectedUrls = await ResolveFileUrlsAsync(
                //     newFiles: model.ExpectedCompletionFiles,
                //     existingUrls: model.ExistingExpectedCompletionFileUrls,
                //     token: token
                // );

                var asIsUrls = await ResolveFileUrlsAsync(
                    model.AsIsRasciFiles,
                    model.ExistingAsIsFileUrls
                );
                var toBeUrls = await ResolveFileUrlsAsync(
                    model.ToBeProcessFiles,
                    model.ExistingToBeFileUrls
                );
                var expectedUrls = await ResolveFileUrlsAsync(
                    model.ExpectedCompletionFiles,
                    model.ExistingExpectedCompletionFileUrls
                );

                var req = new FormRicResubmitRequest
                {
                    Judul = model.JudulPermintaan ?? "",
                    Hastag = (model.Hashtags ?? new List<string>()).Select(NormalizeTag).ToList(),

                    AsIsProcessRasciFile = asIsUrls,

                    Permasalahan = model.Permasalahan ?? "",
                    DampakMasalah = model.DampakMasalah ?? "",
                    FaktorPenyebabMasalah = model.FaktorPenyebab ?? "",
                    SolusiSaatIni = model.SolusiSaatIni ?? "",

                    AlternatifSolusi = model.Alternatifs ?? new List<string>(),

                    ToBeProcessBusinessRasciKkiFile = toBeUrls,
                    PotensiValueCreation = model.PotentialValue ?? "",
                    ExcpectedCompletionTargetFile = expectedUrls,
                    HasilSetelahPerbaikan = model.HasilSetelahPerbaikan ?? "",

                    Status = 0, // TODO: set sesuai status Forward di backend lo
                };

                var ok = await _ricService.ForwardAsync(model.Id, req, token);
                if (!ok)
                {
                    ModelState.AddModelError("", "Gagal forward RIC ke API.");
                    return View("~/Views/Ric/Review/Form.cshtml", model);
                }

                return RedirectToAction(nameof(ReviewIndex));
            }

            ModelState.AddModelError("", "Action tidak valid.");
            return View("~/Views/Ric/Review/Form.cshtml", model);
        }

        // [RoleRequired(4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)]
        // [HttpPost("ric/review")]
        // [ValidateAntiForgeryToken]
        // public async Task<IActionResult> ReviewForm(
        //     RicCreateViewModel model,
        //     string action,
        //     string? note
        // )
        // {
        //     var token = GetAuthToken();
        //     if (string.IsNullOrEmpty(token))
        //         return RedirectToLogin();

        //     if (!ModelState.IsValid)
        //         return View("~/Views/Ric/Review/Form.cshtml", model);

        //     if (action == "reject")
        //     {
        //         await _ricService.RejectAsync(model.Id, note, token);
        //         return RedirectToAction(nameof(ReviewIndex));
        //         // return View("~/Views/Ric/Review/Form.cshtml", model);
        //     }

        //     ModelState.AddModelError("", "Action tidak valid.");
        //     return View("~/Views/Ric/Review/Form.cshtml", model);
        // }

        // [RoleRequired(4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)]
        // [HttpPost("ric/review")]
        // [ValidateAntiForgeryToken]
        // public async Task<IActionResult> ReviewForm(
        //     RicCreateViewModel model,
        //     string action,
        //     string? note
        // )
        // {
        //     var token = GetAuthToken();
        //     if (string.IsNullOrEmpty(token))
        //         return RedirectToLogin();

        //     if (!ModelState.IsValid)
        //         return View("~/Views/Ric/Review/Form.cshtml", model);

        //     var id = model.Id;
        //     var userRoleStr = HttpContext.Session.GetString("UserRole"); // "4","5","8",...
        //     var isBr = userRoleStr is "4" or "5" or "6" or "7";
        //     var isSarm = userRoleStr is "8" or "9" or "10" or "11";
        //     var isEcs = userRoleStr is "12" or "13" or "14" or "15";

        //     _logger.LogInformation(
        //         "ReviewForm POST | Id={Id} | Action={Action} | Note={Note} | UserRoleStr={UserRoleStr} | isBr={isBr}",
        //         model.Id,
        //         action,
        //         note,
        //         userRoleStr,
        //         isBr
        //     );

        //     try
        //     {
        //         var existing = await _ricService.GetRicByIdAsync(id, token);
        //         if (existing == null)
        //             return NotFound();

        //         // Update konten RIC (kalau reviewer boleh edit)
        //         var dto = await RicMapper.MapToUpdateRequestAsync(
        //             id,
        //             model,
        //             action,
        //             existing,
        //             files => FileStorageHelper.SaveRicFilesAsync(files, _env.WebRootPath, _logger)
        //         );

        //         _logger.LogInformation(
        //             "ReviewForm DTO | Id={Id} | Judul={Judul} | Status={Status} | AsIsCount={AsIsCount} | ToBeCount={ToBeCount} | ExpectedCount={ExpectedCount}",
        //             dto.Id,
        //             dto.Judul,
        //             dto.Status,
        //             dto.AsIsProcessRasciFile?.Count ?? 0,
        //             dto.ToBeProcessBusinessRasciKkiFile?.Count ?? 0,
        //             dto.ExcpectedCompletionTargetFile?.Count ?? 0
        //         );

        //         await _ricService.UpdateRicAsync(id, dto, token);

        //         // Tentukan action string ke backend (backend yang mapping ke status enum)
        //         string reviewAction;
        //         if (action == "reject")
        //         {
        //             if (isBr)
        //                 reviewAction = "Reject_BR";
        //             else if (isSarm)
        //                 reviewAction = "Reject_SARM";
        //             else if (isEcs)
        //                 reviewAction = "Reject_ECS";
        //             else
        //                 reviewAction = "Reject_Unknown";
        //         }
        //         else
        //         {
        //             if (isBr)
        //                 reviewAction = "Approve_BR";
        //             else if (isSarm)
        //                 reviewAction = "Approve_SARM";
        //             else if (isEcs)
        //                 reviewAction = "Approve_ECS";
        //             else
        //                 reviewAction = "Approve_Unknown";
        //         }

        //         var reviewDto = new RicReviewRequest { Action = reviewAction, Note = note };

        //         await _ricService.ReviewRicAsync(id, reviewDto, token);

        //         TempData["SuccessMessage"] =
        //             action == "reject"
        //                 ? "RIC berhasil direject."
        //                 : "RIC disetujui dan dilanjutkan.";

        //         return RedirectToAction(nameof(ReviewIndex));
        //     }
        //     catch (Exception ex)
        //     {
        //         _logger.LogError(ex, "Error review RIC {Id}", id);
        //         ModelState.AddModelError(
        //             string.Empty,
        //             "Terjadi kesalahan saat memproses review RIC."
        //         );
        //         return View("~/Views/Ric/Review/Form.cshtml", model);
        //     }
        // }

        #endregion

        #region Private Helpers

        private string? GetAuthToken()
        {
            return HttpContext.Session.GetString("JwtToken");
        }

        private IActionResult RedirectToLogin()
        {
            return RedirectToAction("Login", "Auth");
        }

        // private async Task<List<string>> ResolveFileUrlsAsync(
        //     IEnumerable<IFormFile>? newFiles,
        //     List<string>? existingUrls,
        //     string token
        // )
        // {
        //     var result = new List<string>();

        //     // keep existing
        //     if (existingUrls != null && existingUrls.Count > 0)
        //         result.AddRange(existingUrls);

        //     // upload new files if any
        //     if (newFiles != null)
        //     {
        //         foreach (var f in newFiles.Where(x => x != null && x.Length > 0))
        //         {
        //             // TODO: panggil upload service lo
        //             // var url = await _fileService.UploadAsync(f, token);
        //             // result.Add(url);

        //             throw new NotImplementedException("Upload logic belum di-implement.");
        //         }
        //     }

        //     return result;
        // }

        // private async Task<List<string>> ResolveFileUrlsAsync(
        //     IFormFileCollection? newFiles,
        //     List<string>? existingUrls,
        //     string token // token ga kepake di versi ini, tapi biar signature lu tetep sama
        // )
        // {
        //     // kalau user upload file baru -> pakai hasil upload baru (replace)
        //     if (newFiles != null && newFiles.Count > 0)
        //     {
        //         var saved = await FileStorageHelper.SaveRicFilesAsync(
        //             newFiles,
        //             _env.WebRootPath,
        //             _logger
        //         );
        //         return saved?.Where(x => !string.IsNullOrWhiteSpace(x)).ToList()
        //             ?? new List<string>();
        //     }

        //     // kalau ga upload file baru -> keep existing
        //     return existingUrls?.Where(x => !string.IsNullOrWhiteSpace(x)).Distinct().ToList()
        //         ?? new List<string>();
        // }

        private async Task<List<string>> ResolveFileUrlsAsync(
            IEnumerable<IFormFile>? newFiles,
            List<string>? existingUrls
        )
        {
            // kalau ada file baru -> replace
            var uploaded = newFiles?.Where(f => f != null && f.Length > 0).ToList();
            if (uploaded is { Count: > 0 })
            {
                // FileStorageHelper butuh IFormFileCollection -> convert
                var coll = new FormFileCollection();
                foreach (var f in uploaded)
                    coll.Add(f);

                var saved = await FileStorageHelper.SaveRicFilesAsync(
                    coll,
                    _env.WebRootPath,
                    _logger
                );

                return saved?.Where(x => !string.IsNullOrWhiteSpace(x)).ToList()
                    ?? new List<string>();
            }

            // kalau ga upload baru -> keep existing
            return existingUrls?.Where(x => !string.IsNullOrWhiteSpace(x)).Distinct().ToList()
                ?? new List<string>();
        }

        private static string NormalizeTag(string tag)
        {
            if (string.IsNullOrWhiteSpace(tag))
                return "";

            var t = tag.Trim();

            // buang prefix '#'
            if (t.StartsWith("#"))
                t = t.Substring(1);

            t = t.Trim().ToLowerInvariant();

            // ganti spasi jadi underscore
            t = Regex.Replace(t, @"\s+", "_");

            // whitelist: huruf/angka/_/-
            t = Regex.Replace(t, @"[^a-z0-9_\-]", "");

            return t;
        }

        #endregion
    }
}
